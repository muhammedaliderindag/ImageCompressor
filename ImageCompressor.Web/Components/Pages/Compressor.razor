@page "/compressor"
@using SixLabors.ImageSharp
@using SixLabors.ImageSharp.Formats.Jpeg
@using SixLabors.ImageSharp.Processing
@using ImageCompressor.Web.Data
@using System.Security.Claims
@using Microsoft.AspNetCore.Components.Authorization
@inject HistoryService HistoryService
@inject AuthenticationStateProvider AuthStateProvider
@rendermode InteractiveServer

<PageTitle>Resim Sıkıştırıcı Aracı</PageTitle>

<div class="w-100" style="max-width: 800px; margin: 0 auto;">

    <div class="glass-card fade-in-up">
        <div class="text-center mb-4">
            <i class="bi bi-tools display-4 text-primary"></i>
            <h3 class="mt-3">Resim Optimize Aracı</h3>
        </div>

        <InputFile OnChange="@OnInputFileChange" class="form-control form-control-lg bg-dark text-white border-secondary mb-3" accept=".jpg,.jpeg,.png" />

        @if (uploadedFile != null)
        {
            <div class="p-3 border border-secondary rounded bg-opacity-10 bg-black">

                @* --- ÖNİZLEME ALANI --- *@
                @if (!string.IsNullOrEmpty(previewBase64))
                {
                    <div class="text-center mb-4">
                        <h6 class="text-muted mb-2">Seçilen Resim (Önizleme)</h6>
                        <img src="@previewBase64" class="img-fluid rounded shadow border border-secondary"
                             style="max-height: 250px; object-fit: contain;" />
                        <div class="small text-muted mt-1">
                            Orijinal Boyut: @FormatSize(uploadedFile.Size)
                        </div>
                    </div>
                    <hr class="border-secondary" />
                }

                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label">Genişlik (px)</label>
                        <input type="number" @bind="targetWidth" class="form-control" placeholder="Örn: 800" />
                    </div>

                    <div class="col-md-6">
                        <label class="form-label">Yükseklik (px)</label>
                        <input type="number"
                               @bind="targetHeight"
                               class="form-control"
                               placeholder="@(maintainAspectRatio ? "Otomatik (Orantılı)" : "Örn: 600")"
                               disabled="@maintainAspectRatio" />
                    </div>

                    <div class="col-12">
                        <label class="form-label">Kalite: % @quality</label>
                        <input type="range" @bind="quality" min="10" max="100" class="form-range" />
                    </div>

                    <div class="col-12">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox"
                                   checked="@maintainAspectRatio"
                                   @onchange="ToggleAspectRatio"
                                   id="aspectCheck">
                            <label class="form-check-label" for="aspectCheck">En-Boy Oranını Koru</label>
                        </div>
                        @if (maintainAspectRatio)
                        {
                            <small class="text-muted">
                                * Yükseklik, girdiğiniz genişliğe göre otomatik hesaplanır.
                            </small>
                        }
                    </div>
                </div>

                <button class="btn btn-primary w-100 mt-3" @onclick="ProcessImage" disabled="@isLoading">
                    @if (isLoading)
                    {
                        <span><span class="spinner-border spinner-border-sm me-2"></span>İşleniyor...</span>
                    }
                    else
                    {
                        <span>🚀 İşlemi Başlat</span>
                    }
                </button>
            </div>
        }

        @if (resultBase64 != null)
        {
            var isSizeIncreased = processedSize > (uploadedFile?.Size ?? 0);
            var ratio = CalculateRatio();

            <div class="mt-4 text-center p-3 rounded border @(isSizeIncreased ? "border-danger bg-danger bg-opacity-10" : "border-success bg-success bg-opacity-10")">

                @if (isSizeIncreased)
                {
                    <h5 class="text-danger fw-bold">⚠️ Dosya Boyutu Arttı!</h5>
                    <p>
                        Eski: @FormatSize(uploadedFile!.Size) → Yeni: @FormatSize(processedSize)<br />
                        <span class="badge bg-danger">Artış: +%@ratio</span>
                    </p>
                }
                else
                {
                    <h5 class="text-success fw-bold">✅ İşlem Başarılı!</h5>
                    <p>
                        Eski: @FormatSize(uploadedFile!.Size) → Yeni: @FormatSize(processedSize)<br />
                        <span class="badge bg-success">Tasarruf: -%@ratio</span>
                    </p>
                }

                <img src="@resultBase64" class="img-fluid rounded shadow mb-3" style="max-height: 300px;" />
                <br />
                <a href="@resultBase64" download="optimized.jpg" class="btn @(isSizeIncreased ? "btn-outline-danger" : "btn-success") rounded-pill px-4">
                    ⬇️ İndir
                </a>
            </div>
        }
    </div>

</div>

@code {
    private IBrowserFile? uploadedFile;
    private string? resultBase64;
    private string? previewBase64;
    private long processedSize;
    private bool isLoading = false;
    private int? targetWidth;
    private int? targetHeight;
    private int quality = 60;
    private bool maintainAspectRatio = true;

    private async Task OnInputFileChange(InputFileChangeEventArgs e)
    {
        uploadedFile = e.File;
        resultBase64 = null;
        previewBase64 = null;

        try
        {
            var maxFileSize = 20L * 1024 * 1024; // 20MB Limit
            using var stream = uploadedFile.OpenReadStream(maxFileSize);
            using var memoryStream = new MemoryStream();
            await stream.CopyToAsync(memoryStream);

            var buffer = memoryStream.ToArray();
            var format = uploadedFile.ContentType;
            previewBase64 = $"data:{format};base64,{Convert.ToBase64String(buffer)}";
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Önizleme hatası: {ex.Message}");
        }
    }

    private void ToggleAspectRatio(ChangeEventArgs e)
    {
        maintainAspectRatio = (bool)(e.Value ?? true);
        if (maintainAspectRatio) targetHeight = null;
    }

    private async Task ProcessImage()
    {
        if (uploadedFile == null) return;
        isLoading = true;
        await Task.Delay(1);

        try
        {
            using var stream = uploadedFile.OpenReadStream(20L * 1024 * 1024);
            using var memoryStream = new MemoryStream();
            await stream.CopyToAsync(memoryStream);
            memoryStream.Position = 0;

            using var image = await Image.LoadAsync(memoryStream);

            if (targetWidth.HasValue || targetHeight.HasValue)
            {
                var resizeOptions = new ResizeOptions
                {
                    Size = new Size(targetWidth ?? 0, targetHeight ?? 0),
                    Mode = maintainAspectRatio ? ResizeMode.Max : ResizeMode.Stretch
                };
                image.Mutate(x => x.Resize(resizeOptions));
            }

            var encoder = new JpegEncoder { Quality = quality };
            using var outputStream = new MemoryStream();
            await image.SaveAsJpegAsync(outputStream, encoder);

            processedSize = outputStream.Length;
            var base64 = Convert.ToBase64String(outputStream.ToArray());
            resultBase64 = $"data:image/jpeg;base64,{base64}";

            // --- GEÇMİŞ KAYDETME (DÜZELTİLEN KISIM) ---
            try
            {
                var authState = await AuthStateProvider.GetAuthenticationStateAsync();
                var user = authState.User;

                if (user.Identity != null && user.Identity.IsAuthenticated)
                {
                    // HATA BURADAYDI: Sadece ClaimTypes.NameIdentifier'a bakıyordu.
                    // ARTIK: "nameid", "sub" veya "ClaimTypes.NameIdentifier" hepsine bakıyor.
                    var userIdClaim = user.Claims.FirstOrDefault(c =>
                        c.Type == ClaimTypes.NameIdentifier ||
                        c.Type == "nameid" ||
                        c.Type == "sub" ||
                        c.Type == "id");

                    if (userIdClaim != null && int.TryParse(userIdClaim.Value, out int userId))
                    {
                        string details = $"{FormatSize(uploadedFile!.Size)} -> {FormatSize(processedSize)}";
                        await HistoryService.AddHistoryAsync(userId, "Compress", uploadedFile.Name, details);
                        Console.WriteLine($"Geçmiş kaydedildi: User {userId}");
                    }
                    else
                    {
                        Console.WriteLine("Kullanıcı ID bulunamadı! Token claim'lerini kontrol edin.");
                    }
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine("Geçmiş kaydedilemedi (Veritabanı Hatası): " + ex.Message);
            }
            // ------------------------------------------
        }
        catch (Exception ex)
        {
            Console.WriteLine($"İşlem Hatası: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private string FormatSize(long bytes) => bytes > 1024 * 1024 ?
        $"{(bytes / 1048576.0):F2} MB" : $"{(bytes / 1024.0):F2} KB";

    private string CalculateRatio()
    {
        if (uploadedFile == null || uploadedFile.Size == 0) return "0";
        long diff = processedSize - uploadedFile.Size;
        double ratio = (double)Math.Abs(diff) / uploadedFile.Size * 100;
        return ratio.ToString("F1");
    }
}