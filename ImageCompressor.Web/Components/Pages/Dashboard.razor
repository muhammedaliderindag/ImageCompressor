@page "/dashboard"
@using ImageCompressor.Web.Data
@using ImageCompressor.Web.Auth
@using System.Security.Claims
@using Microsoft.AspNetCore.Components.Authorization
@using System.Timers
@inject SystemMonitorService MonitorService
@inject AuthService AuthService
@inject HistoryService HistoryService 
@inject AuthenticationStateProvider AuthStateProvider
@inject NavigationManager NavManager
@rendermode @(new InteractiveServerRenderMode(prerender: false))
@implements IDisposable

<PageTitle>Sistem Paneli</PageTitle>

@if (isLoading)
{
    <div class="container mt-5 text-center">
        <div class="glass-card fade-in-up py-5">
            <div class="spinner-border text-primary mb-3" role="status"></div>
            <h4 class="text-white">Panel Yükleniyor...</h4>
        </div>
    </div>
}
else if (isAuthorized)
{
    <div class="container mt-4">
        
        @* --- 1. BÖLÜM: SİSTEM METRİKLERİ --- *@
        <div class="glass-card fade-in-up mb-4">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h3 class="text-white mb-0"><i class="bi bi-speedometer2 me-2"></i>Sistem Durumu</h3>
                    <small class="text-muted">Canlı sunucu kaynak kullanımı</small>
                </div>
                <div class="text-end">
                    <span class="badge bg-success animate-pulse mb-1">● Canlı</span>
                    <div class="small text-muted" style="font-size: 0.75rem">Tazeleme: 1sn</div>
                </div>
            </div>

            <div class="row g-4">
                @* RAM Kartı *@
                <div class="col-md-6">
                    <div class="p-4 rounded border border-secondary bg-dark bg-opacity-50 h-100">
                         <h5 class="text-info"><i class="bi bi-memory me-2"></i>RAM</h5>
                         <div class="progress bg-secondary bg-opacity-25" style="height: 20px;">
                            <div class="progress-bar bg-info progress-bar-striped progress-bar-animated" 
                                 style="width: @((int)metrics.MemoryUsagePercent)%"></div>
                        </div>
                        <div class="mt-2 text-white text-center">% @metrics.MemoryUsagePercent.ToString("F1")</div>
                        <div class="text-muted small text-center">@FormatSize(metrics.MemoryUsed) / @FormatSize(metrics.TotalMemory)</div>
                    </div>
                </div>

                @* CPU Kartı *@
                <div class="col-md-6">
                     <div class="p-4 rounded border border-secondary bg-dark bg-opacity-50 h-100">
                         <h5 class="text-warning"><i class="bi bi-cpu me-2"></i>CPU</h5>
                         <div class="progress bg-secondary bg-opacity-25" style="height: 20px;">
                            <div class="progress-bar @GetCpuColor(metrics.CpuUsagePercent) progress-bar-striped progress-bar-animated" 
                                 style="width: @((int)metrics.CpuUsagePercent)%"></div>
                        </div>
                        <div class="mt-2 text-white text-center">% @metrics.CpuUsagePercent.ToString("F1")</div>
                        <div class="text-muted small text-center">@metrics.ProcessorCount Çekirdek</div>
                    </div>
                </div>
            </div>
        </div>

        @* --- 2. BÖLÜM: KULLANICI YÖNETİMİ --- *@
        <div class="glass-card fade-in-up">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h3 class="text-white mb-0"><i class="bi bi-people-fill me-2"></i>Kullanıcı Yönetimi</h3>
                <span class="badge bg-primary rounded-pill">Toplam: @userList.Count</span>
            </div>

            <div class="table-responsive">
                <table class="table table-dark table-hover bg-transparent border-secondary align-middle">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Ad Soyad</th>
                            <th>Kullanıcı Adı</th>
                            <th>Rol</th>
                            <th class="text-end">İşlemler</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var user in userList)
                        {
                            <tr>
                                <td>#@user.Id</td>
                                <td class="fw-bold">@user.FirstName @user.LastName</td>
                                <td>@user.Username</td>
                                <td>
                                    @if(user.Role == "Admin")
                                    { <span class="badge bg-danger">Yönetici</span> }
                                    else
                                    { <span class="badge bg-secondary">Kullanıcı</span> }
                                </td>
                                <td class="text-end">
                                    @* btn-group sildik, yerine d-flex ve gap-2 ekledik *@
                                    <div class="d-flex gap-2 justify-content-end">

                                        @* İŞLEM GEÇMİŞİ BUTONU *@
                                        <button class="btn btn-outline-info btn-sm" @onclick="() => ViewUserHistory(user)">
                                            <i class="bi bi-clock-history"></i> Geçmiş
                                        </button>

                                        @if (user.Id != currentUserId)
                                        {
                                            <button class="btn btn-outline-danger btn-sm" @onclick="() => DeleteUser(user)">
                                                <i class="bi bi-trash"></i> Sil
                                            </button>
                                        }
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
}

@* --- MODAL (POP-UP) --- *@
@if (showHistoryModal)
{
    <div class="modal-backdrop fade show"></div>
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
            @* Modal İçeriği - Glass Effect uygulandı *@
            <div class="modal-content text-white border-secondary" style="background: rgba(17, 25, 40, 0.95); backdrop-filter: blur(16px);">
                <div class="modal-header border-bottom border-secondary">
                    <h5 class="modal-title">
                        <i class="bi bi-person-lines-fill me-2"></i>
                        @selectedUserName <span class="text-muted small ms-2">İşlem Geçmişi</span>
                    </h5>
                    <button type="button" class="btn-close btn-close-white" @onclick="CloseHistoryModal"></button>
                </div>
                <div class="modal-body">
                    @if (isHistoryLoading)
                    {
                        <div class="text-center py-4">
                            <div class="spinner-border text-info" role="status"></div>
                            <p class="mt-2 text-muted">Geçmiş yükleniyor...</p>
                        </div>
                    }
                    else if (selectedUserHistory.Any())
                    {
                        <div class="table-responsive">
                            <table class="table table-dark table-sm table-hover bg-transparent mb-0">
                                <thead>
                                    <tr>
                                        <th class="text-muted">Tarih</th>
                                        <th>İşlem</th>
                                        <th>Dosya</th>
                                        <th>Detay</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var h in selectedUserHistory)
                                    {
                                        <tr>
                                            <td class="text-muted small">@h.CreatedAt.ToLocalTime().ToString("dd.MM.yy HH:mm")</td>
                                            <td><span class="badge bg-secondary">@h.ActionType</span></td>
                                            <td class="small text-truncate" style="max-width: 150px;">@h.FileName</td>
                                            <td class="small text-success">@h.Details</td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                    else
                    {
                        <div class="text-center py-4 text-muted">
                            <i class="bi bi-inbox display-4 opacity-50"></i>
                            <p class="mt-2">Bu kullanıcı henüz işlem yapmamış.</p>
                        </div>
                    }
                </div>
                <div class="modal-footer border-top border-secondary">
                    <button type="button" class="btn btn-secondary" @onclick="CloseHistoryModal">Kapat</button>
                </div>
            </div>
        </div>
    </div>
}

<style>
    .animate-pulse { animation: pulse 1.5s infinite; }
    @@keyframes pulse { 0% { opacity: 0.6; } 50% { opacity: 1; } 100% { opacity: 0.6; } }
</style>

@code {
    private SystemMetrics metrics = new();
    private List<UserAccount> userList = new();
    private Timer? _timer;
    private bool isLoading = true;
    private bool isAuthorized = false;
    private int currentUserId;

    // --- MODAL DEĞİŞKENLERİ ---
    private bool showHistoryModal = false;
    private bool isHistoryLoading = false;
    private string selectedUserName = "";
    private List<UserHistory> selectedUserHistory = new();
    // --------------------------

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;

            if (user.Identity == null || !user.Identity.IsAuthenticated)
            {
                NavManager.NavigateTo("login");
                return;
            }

            var roleClaim = user.Claims.FirstOrDefault(c => c.Type == "role" || c.Type == ClaimTypes.Role);
            if (roleClaim == null || !roleClaim.Value.Equals("Admin", StringComparison.OrdinalIgnoreCase))
            {
                NavManager.NavigateTo("/");
                return;
            }

            var idClaim = user.Claims.FirstOrDefault(c => c.Type == ClaimTypes.NameIdentifier || c.Type == "nameid" || c.Type == "id");
            if (idClaim != null && int.TryParse(idClaim.Value, out int uid))
            {
                currentUserId = uid;
            }

            isAuthorized = true;
            StartMonitoring();
            userList = AuthService.GetAllUsers();
            isLoading = false;
            StateHasChanged();
        }
    }

    private void DeleteUser(UserAccount userToDelete)
    {
        bool result = AuthService.DeleteUser(userToDelete.Id);
        if (result)
        {
            userList.Remove(userToDelete);
            StateHasChanged();
        }
    }

    // --- MODAL METODLARI ---
    private async Task ViewUserHistory(UserAccount user)
    {
        selectedUserName = $"{user.FirstName} {user.LastName}";
        showHistoryModal = true;
        isHistoryLoading = true;
        StateHasChanged(); // Modalı aç ve spinner göster

        // Veritabanından asenkron olarak geçmişi çek
        selectedUserHistory = await HistoryService.GetUserHistoryAsync(user.Id);
        
        isHistoryLoading = false;
        StateHasChanged(); // Verileri göster
    }

    private void CloseHistoryModal()
    {
        showHistoryModal = false;
        selectedUserHistory.Clear();
    }
    // -----------------------

    private void StartMonitoring()
    {
        metrics = MonitorService.GetMetrics();
        _timer = new Timer(1000);
        _timer.Elapsed += (sender, e) =>
        {
            metrics = MonitorService.GetMetrics();
            InvokeAsync(StateHasChanged);
        };
        _timer.Start();
    }

    private string FormatSize(long bytes)
    {
        if (bytes >= 1073741824) return $"{(bytes / 1073741824.0):F2} GB";
        return bytes > 1048576 ? $"{(bytes / 1048576.0):F2} MB" : $"{(bytes / 1024.0):F2} KB";
    }

    private string GetCpuColor(double percent) => percent switch
    {
        > 80 => "bg-danger",
        > 50 => "bg-warning",
        _ => "bg-success"
    };

    public void Dispose()
    {
        _timer?.Dispose();
    }
}