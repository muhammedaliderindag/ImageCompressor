@page "/convert"
@using SixLabors.ImageSharp
@using SixLabors.ImageSharp.Formats.Jpeg
@using SixLabors.ImageSharp.Formats.Png
@using SixLabors.ImageSharp.Formats.Webp
@using SixLabors.ImageSharp.Formats.Bmp
@using SixLabors.ImageSharp.Formats.Gif
@using ImageCompressor.Web.Data  
@using System.Security.Claims    
@using Microsoft.AspNetCore.Components.Authorization 
@inject HistoryService HistoryService 
@inject AuthenticationStateProvider AuthStateProvider 
@rendermode InteractiveServer

<PageTitle>Format Dönüştürücü</PageTitle>

<div class="w-100" style="max-width: 800px; margin: 0 auto;">
    <div class="glass-card fade-in-up">
        <div class="text-center mb-4">
            <i class="bi bi-arrow-repeat display-4" style="color: #a29bfe;"></i>
            <h3 class="mt-3">Format Dönüştürücü</h3>
        </div>

        <InputFile OnChange="@OnInputFileChange" class="form-control form-control-lg bg-dark text-white border-secondary mb-3" accept=".jpg,.jpeg,.png,.webp,.bmp,.gif" />

        @if (uploadedFile != null)
        {
            <div class="p-4 border border-secondary rounded bg-opacity-10 bg-black">
                
                @* --- ÖNİZLEME ALANI --- *@
                @if (!string.IsNullOrEmpty(previewBase64))
                {
                    <div class="text-center mb-4">
                        <h6 class="text-muted mb-2">Seçilen Resim</h6>
                        <img src="@previewBase64" class="img-fluid rounded shadow border border-secondary" 
                             style="max-height: 250px; object-fit: contain;" />
                        <div class="small text-muted mt-1">
                            Orijinal Boyut: @FormatSize(uploadedFile.Size)
                        </div>
                    </div>
                    <hr class="border-secondary" />
                }
                
                <div class="row g-3 align-items-end">
                    <div class="col-md-8">
                        <label class="form-label">Hedef Format</label>
                        <select @bind="targetFormat" class="form-select form-select-lg bg-dark text-white border-secondary">
                            <option value="jpeg">JPG</option>
                            <option value="png">PNG</option>
                            <option value="webp">WEBP</option>
                            <option value="bmp">BMP</option>
                            <option value="gif">GIF</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <button class="btn w-100 btn-lg text-white" style="background-color: #6c5ce7;" @onclick="ProcessConvert" disabled="@isLoading">
                            @if (isLoading)
                            {
                                <span><span class="spinner-border spinner-border-sm me-2"></span>İşleniyor...</span>
                            }
                            else
                            {
                                <span>🔄 Dönüştür</span>
                            }
                        </button>
                    </div>
                </div>
            </div>
        }

        @if (resultBase64 != null)
        {
            <div class="mt-4 text-center p-3 border rounded" style="border-color: #a29bfe; background-color: rgba(162, 155, 254, 0.1);">
                <h5 style="color: #a29bfe;">Dönüşüm Tamamlandı!</h5>
                <p>Boyut: @FormatSize(processedSize)</p>
                <img src="@resultBase64" class="img-fluid rounded shadow mb-3" style="max-height: 300px;" />
                <br />
                <a href="@resultBase64" download="converted.@GetExtension()" class="btn text-white rounded-pill px-5 shadow" style="background-color: #6c5ce7;">⬇️ İndir</a>
            </div>
        }
    </div>
</div>

@code {
    private IBrowserFile? uploadedFile;
    private string? resultBase64;
    private string? previewBase64;
    private long processedSize;
    private bool isLoading = false;
    private string targetFormat = "jpeg";

    private async Task OnInputFileChange(InputFileChangeEventArgs e)
    {
        uploadedFile = e.File;
        resultBase64 = null;
        previewBase64 = null;

        try
        {
            var maxFileSize = 20L * 1024 * 1024;
            using var stream = uploadedFile.OpenReadStream(maxFileSize);
            using var ms = new MemoryStream();
            await stream.CopyToAsync(ms);
            
            var buffer = ms.ToArray();
            var format = uploadedFile.ContentType;
            previewBase64 = $"data:{format};base64,{Convert.ToBase64String(buffer)}";
        }
        catch (Exception ex)
        {
             Console.WriteLine($"Önizleme Hatası: {ex.Message}");
        }
    }

    private async Task ProcessConvert()
    {
        if (uploadedFile == null) return;
        isLoading = true;
        await Task.Delay(1);
        try
        {
            using var stream = uploadedFile.OpenReadStream(20L * 1024 * 1024);
            using var ms = new MemoryStream();
            await stream.CopyToAsync(ms);
            ms.Position = 0;
            
            using var image = await Image.LoadAsync(ms);
            using var os = new MemoryStream();
            
            switch (targetFormat)
            {
                case "png": await image.SaveAsPngAsync(os); break;
                case "webp": await image.SaveAsWebpAsync(os); break;
                case "bmp": await image.SaveAsBmpAsync(os); break;
                case "gif": await image.SaveAsGifAsync(os); break;
                default: await image.SaveAsJpegAsync(os); break;
            }
            
            processedSize = os.Length;
            resultBase64 = $"data:image/{targetFormat};base64,{Convert.ToBase64String(os.ToArray())}";

            // --- GEÇMİŞ KAYDETME (EKLENEN KISIM) ---
            try
            {
                var authState = await AuthStateProvider.GetAuthenticationStateAsync();
                var user = authState.User;

                if (user.Identity != null && user.Identity.IsAuthenticated)
                {
                    var userIdClaim = user.Claims.FirstOrDefault(c => 
                        c.Type == ClaimTypes.NameIdentifier || 
                        c.Type == "nameid" || 
                        c.Type == "sub" ||
                        c.Type == "id");

                    if (userIdClaim != null && int.TryParse(userIdClaim.Value, out int userId))
                    {
                        // Detay Örneği: "JPG -> PNG | 2.5 MB"
                        string fromExt = Path.GetExtension(uploadedFile.Name).TrimStart('.').ToUpper();
                        string toExt = GetExtension().ToUpper();
                        string details = $"{fromExt} -> {toExt} | {FormatSize(processedSize)}";

                        await HistoryService.AddHistoryAsync(userId, "Convert", uploadedFile.Name, details);
                    }
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine("Geçmiş kaydedilemedi: " + ex.Message);
            }
            // ---------------------------------------
        }
        catch { }
        finally
        {
            isLoading = false;
        }
    }

    private string GetExtension() => targetFormat == "jpeg" ? "jpg" : targetFormat;
    private string FormatSize(long b) => b > 1024 * 1024 ? $"{(b / 1048576.0):F2} MB" : $"{(b / 1024.0):F2} KB";
}