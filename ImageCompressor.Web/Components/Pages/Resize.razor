@page "/resize"
@using SixLabors.ImageSharp
@using SixLabors.ImageSharp.Formats.Jpeg
@using SixLabors.ImageSharp.Processing
@using ImageCompressor.Web.Data  
@using System.Security.Claims    
@using Microsoft.AspNetCore.Components.Authorization 
@inject HistoryService HistoryService 
@inject AuthenticationStateProvider AuthStateProvider 
@rendermode InteractiveServer

<PageTitle>Resim Boyutlandır</PageTitle>

<div class="w-100" style="max-width: 800px; margin: 0 auto;">
    <div class="glass-card fade-in-up">
        <div class="text-center mb-4">
            <i class="bi bi-aspect-ratio display-4 text-warning"></i>
            <h3 class="mt-3">Resim Boyutlandırıcı</h3>
        </div>

        <InputFile OnChange="@OnInputFileChange" class="form-control form-control-lg bg-dark text-white border-secondary mb-3" accept=".jpg,.jpeg,.png" />

        @if (uploadedFile != null)
        {
            <div class="p-4 border border-secondary rounded bg-opacity-10 bg-black">
                
                @* --- ÖNİZLEME ALANI --- *@
                @if (!string.IsNullOrEmpty(previewBase64))
                {
                    <div class="text-center mb-4">
                        <h6 class="text-muted mb-2">Seçilen Resim</h6>
                        <img src="@previewBase64" class="img-fluid rounded shadow border border-secondary" 
                             style="max-height: 250px; object-fit: contain;" />
                        <div class="small text-muted mt-1">
                            Orijinal Boyut: @FormatSize(uploadedFile.Size)
                        </div>
                    </div>
                    <hr class="border-secondary" />
                }
                
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label">Genişlik</label>
                        <input type="number" @bind="targetWidth" class="form-control" placeholder="Örn: 1920" />
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Yükseklik</label>
                        <input type="number" @bind="targetHeight" class="form-control" 
                               placeholder="@(maintainAspectRatio ? "Otomatik" : "Örn: 1080")" 
                               disabled="@maintainAspectRatio" />
                    </div>
                    <div class="col-12">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" @bind="maintainAspectRatio" @oninput="ToggleAspectRatio" id="aspectSwitch">
                            <label class="form-check-label" for="aspectSwitch">En-Boy Oranını Koru</label>
                        </div>
                    </div>
                    <div class="col-12 mt-4">
                        <button class="btn btn-warning w-100 text-dark fw-bold" @onclick="ProcessResize" disabled="@isLoading">
                            @if (isLoading)
                            {
                                <span><span class="spinner-border spinner-border-sm me-2"></span>İşleniyor...</span>
                            }
                            else
                            {
                                <span>📐 Boyutlandır</span>
                            }
                        </button>
                    </div>
                </div>
            </div>
        }

        @if (resultBase64 != null)
        {
            <div class="mt-4 text-center p-3 border border-warning rounded bg-warning bg-opacity-10">
                <h5 class="text-warning">Başarılı!</h5>
                <p>Yeni Boyut: @FormatSize(processedSize)</p>
                <img src="@resultBase64" class="img-fluid rounded shadow mb-3" style="max-height: 300px;" />
                <br />
                <a href="@resultBase64" download="resized.jpg" class="btn btn-warning text-dark fw-bold rounded-pill px-4">⬇️ İndir</a>
            </div>
        }
    </div>
</div>

@code {
    private IBrowserFile? uploadedFile;
    private string? resultBase64;
    private string? previewBase64;
    private long processedSize;
    private bool isLoading = false;
    private int? targetWidth;
    private int? targetHeight;
    private bool maintainAspectRatio = true;

    private async Task OnInputFileChange(InputFileChangeEventArgs e)
    {
        uploadedFile = e.File;
        resultBase64 = null;
        previewBase64 = null;
        
        try
        {
            var maxFileSize = 20L * 1024 * 1024;
            using var stream = uploadedFile.OpenReadStream(maxFileSize);
            using var ms = new MemoryStream();
            await stream.CopyToAsync(ms);
            
            var buffer = ms.ToArray();
            var format = uploadedFile.ContentType;
            previewBase64 = $"data:{format};base64,{Convert.ToBase64String(buffer)}";
        }
        catch (Exception ex)
        {
             Console.WriteLine($"Önizleme Hatası: {ex.Message}");
        }
    }

    private void ToggleAspectRatio(ChangeEventArgs e)
    {
        maintainAspectRatio = (bool)(e.Value ?? true);
        if (maintainAspectRatio) targetHeight = null;
    }

    private async Task ProcessResize()
    {
        if (uploadedFile == null || (targetWidth == null && targetHeight == null)) return;
        isLoading = true;
        await Task.Delay(1);
        try
        {
            using var s = uploadedFile.OpenReadStream(20L * 1024 * 1024);
            using var ms = new MemoryStream();
            await s.CopyToAsync(ms);
            ms.Position = 0;
            
            using var img = await Image.LoadAsync(ms);
            
            img.Mutate(x => x.Resize(new ResizeOptions { 
                Size = new Size(targetWidth ?? 0, targetHeight ?? 0), 
                Mode = maintainAspectRatio ? ResizeMode.Max : ResizeMode.Stretch 
            }));
            
            using var os = new MemoryStream();
            await img.SaveAsJpegAsync(os);
            
            processedSize = os.Length;
            resultBase64 = $"data:image/jpeg;base64,{Convert.ToBase64String(os.ToArray())}";

            // --- GEÇMİŞ KAYDETME (EKLENEN KISIM) ---
            try
            {
                var authState = await AuthStateProvider.GetAuthenticationStateAsync();
                var user = authState.User;

                if (user.Identity != null && user.Identity.IsAuthenticated)
                {
                    // Doğru ID kontrolü
                    var userIdClaim = user.Claims.FirstOrDefault(c => 
                        c.Type == ClaimTypes.NameIdentifier || 
                        c.Type == "nameid" || 
                        c.Type == "sub" ||
                        c.Type == "id");

                    if (userIdClaim != null && int.TryParse(userIdClaim.Value, out int userId))
                    {
                        string details = $"{targetWidth}x{targetHeight} px | {FormatSize(processedSize)}";
                        // ActionType: "Resize" olarak kaydediyoruz
                        await HistoryService.AddHistoryAsync(userId, "Resize", uploadedFile.Name, details);
                    }
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine("Geçmiş kaydedilemedi: " + ex.Message);
            }
            // ---------------------------------------
        }
        catch { }
        finally { isLoading = false; }
    }

    private string FormatSize(long b) => b > 1024 * 1024 ?
        $"{(b / 1048576.0):F2} MB" : $"{(b / 1024.0):F2} KB";
}