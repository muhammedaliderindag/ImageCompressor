@using ImageCompressor.Web.Components.Layout
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Components.Routing
@using ImageCompressor.Web.Components @* RedirectToLogin varsa buraya ekleyin *@
@inject AuthenticationStateProvider AuthStateProvider

@* --- KRİTİK AYAR BURADA --- *@
@* Hem modu seçiyoruz hem de prerender'ı kapatıyoruz. *@
@rendermode @(new InteractiveServerRenderMode(prerender: false))

<CascadingAuthenticationState>
    @if (!isAuthLoaded)
    {
        @* --- SPLASH SCREEN (YÜKLEME EKRANI) --- *@
        <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: #121212; z-index: 9999; display: flex; align-items: center; justify-content: center; flex-direction: column;">
            <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status"></div>
            <h4 class="text-white mt-3" style="font-weight: 300; letter-spacing: 1px;">Yükleniyor...</h4>
        </div>
    }
    else
    {
        @* --- UYGULAMA EKRANI --- *@
        <Router AppAssembly="typeof(Program).Assembly">
            <Found Context="routeData">
                <AuthorizeRouteView RouteData="routeData" DefaultLayout="typeof(MainLayout)">
                    <NotAuthorized>
                        @if (context.User.Identity?.IsAuthenticated != true)
                        {
                            <RedirectToLogin />
                        }
                        else
                        {
                             <p role="alert">Bu sayfayı görüntüleme yetkiniz yok.</p>
                        }
                    </NotAuthorized>
                </AuthorizeRouteView>
                <FocusOnNavigate RouteData="routeData" Selector="h1" />
            </Found>
            <NotFound>
                <LayoutView Layout="typeof(MainLayout)">
                    <div class="text-center mt-5 text-white">
                        <i class="bi bi-exclamation-triangle display-1 text-warning"></i>
                        <h3 class="mt-3">404 - Sayfa Bulunamadı</h3>
                        <p>Aradığınız sayfa mevcut değil.</p>
                    </div>
                </LayoutView>
            </NotFound>
        </Router>
    }
</CascadingAuthenticationState>

@code {
    private bool isAuthLoaded = false;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // Token kontrolü yapılıyor...
            await AuthStateProvider.GetAuthenticationStateAsync();
            
            // Kontrol bitti, ekranı aç.
            isAuthLoaded = true;
            StateHasChanged();
        }
    }
}